---
title: Inverse Numerator Relationship Matrix
author: Peter von Rohr
date: "`r Sys.Date()`"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# rmdhelp::show_knit_hook_call()
knitr::knit_hooks$set(hook_convert_odg = rmdhelp::hook_convert_odg)
```

# Problem 1: Inverse Numerator Relationship Matrix
During the lecture the method of computing the inverse numerator relationship matrix $A^{-1}$ directly was introduced. The computation is based on the LDL-decomposition. As a result, we can write 

$$A^{-1} = (L^T)^{-1} \cdot D^{-1} \cdot L^{-1}$$
where $L^{-1} = I-P$, and $D^{-1}$ is a diagonal matrix with $(D^{-1})_{ii} * \sigma_u^{-2} = var(m_i)^{-1}$.  


## Tasks

* Use the example pedigree given below and compute the matrices $L^{-1}$ and $D^{-1}$ to compute $A^{-1}$
* Verify your result using the function `getAinv()` from package pedigreemm.


## Pedigree

```{r}
nr_animal <- 6
tbl_pedigree <- tibble::tibble(Calf = c(1:nr_animal),
                               Sire = c(NA, NA, NA, 1 ,3, 4),
                               Dam = c(NA, NA, NA, 2, 2, 5))
tbl_pedigree
```


## Solution
The matrix $P$ comes from the simple decomposition and can be constructed using the pedigree.

```{r}
P = matrix(0, nrow = nr_animal, ncol = nr_animal)
for (i in 1:nr_animal){
  s <- tbl_pedigree$Sire[i]
  d <- tbl_pedigree$Dam[i]
  if (!is.na(s)){
    P[i,s] <- 0.5
  }
  if(!is.na(d)){
    P[i,d] <- 0.5
  }
}
P
```

With that the matrix $L^{-1}$ is 

```{r}
I <- diag(1, nrow = nr_animal, ncol = nr_animal)
Linv <- I - P
Linv
```

The matrix $D$ is obtained from package pedigreemm

```{r}
ped <- pedigreemm::pedigree(sire = tbl_pedigree$Sire,
                            dam  = tbl_pedigree$Dam,
                            label = as.character(1:nr_animal))
D <- pedigreemm::Dmat(ped = ped)
Dinv <- diag(1/D, nrow = nr_animal, ncol = nr_animal)
Dinv
```

The inverse numerator relationship matrix is

```{r}
Ainv <- t(Linv) %*% Dinv %*% Linv
Ainv
```


## Verification

```{r}
pedigreemm::getAInv(ped = ped)
```


# Problem 2: Rules
The following diagram helps to illustrate the rules for constructing $A^{-1}$

```{r inv-num-mat, echo=FALSE, hook_convert_odg=TRUE, fig_path="odg", out.width="100%"}
#rmdhelp::use_odg_graphic(ps_path = "odg/inv-num-mat.odg")
knitr::include_graphics(path = "odg/inv-num-mat.png")
```
 
